<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üéÑ AR C√¢y Th√¥ng Noel</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; font-family: Georgia, serif; background: #000; }
    html, body, #root { position: fixed; width: 100%; height: 100%; }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .float-animation { animation: float 2s ease-in-out infinite; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    'use strict';
    
    const { useState, useEffect, useRef, createElement: h } = React;
    
    // ============================================
    // SIMPLIFIED CONFIG - NO MEDIAPIPE DEPENDENCY
    // ============================================
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    const CONFIG = {
      SNOW_PARTICLES: isMobile ? 60 : 120,
      ORNAMENT_COUNT: isMobile ? 10 : 16,
      ENABLE_ANTIALIASING: !isMobile,
      PIXEL_RATIO: isMobile ? 1 : Math.min(window.devicePixelRatio, 2),
      DAMPING: 0.08,
      AUTO_ROTATE_SPEED: 0.005
    };
    
    // ============================================
    // MAIN APP
    // ============================================
    function App() {
      const [appState, setAppState] = useState('INIT');
      const [fps, setFPS] = useState(0);
      const [controlMode, setControlMode] = useState('mouse'); // 'mouse' or 'auto'
      const [showInstructions, setShowInstructions] = useState(true);
      
      const canvasRef = useRef(null);
      const sceneRef = useRef(null);
      const animationFrameRef = useRef(null);
      
      const targetRotation = useRef(0);
      const targetScale = useRef(1);
      const isSpinning = useRef(false);
      const isDragging = useRef(false);
      const lastMouseX = useRef(0);
      
      const frameCount = useRef(0);
      const lastFrameTime = useRef(performance.now());
      
      // ============================================
      // THREE.JS SCENE
      // ============================================
      const initThreeJS = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        // Scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a1f2e);
        
        // Camera
        const camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 1000);
        camera.position.set(0, 2.5, isMobile ? 7 : 6);
        camera.lookAt(0, 2, 0);
        
        // Renderer
        const renderer = new THREE.WebGLRenderer({
          canvas,
          antialias: CONFIG.ENABLE_ANTIALIASING
        });
        renderer.setSize(width, height);
        renderer.setPixelRatio(CONFIG.PIXEL_RATIO);
        
        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
        directionalLight.position.set(5, 10, 5);
        scene.add(directionalLight);
        
        const topLight = new THREE.DirectionalLight(0xffffff, 0.4);
        topLight.position.set(0, 15, 0);
        scene.add(topLight);
        
        // ============================================
        // CHRISTMAS TREE
        // ============================================
        const treeGroup = new THREE.Group();
        
        // Trunk
        const trunk = new THREE.Mesh(
          new THREE.CylinderGeometry(0.2, 0.25, 1, 12),
          new THREE.MeshPhongMaterial({ color: 0x5c3317 })
        );
        trunk.position.y = 0.5;
        trunk.castShadow = true;
        treeGroup.add(trunk);
        
        // Foliage - 3 tiers
        const foliageMaterial = new THREE.MeshPhongMaterial({ 
          color: 0x0d5c2d,
          shininess: 10
        });
        
        const tier1 = new THREE.Mesh(
          new THREE.ConeGeometry(1.3, 1.6, 12), 
          foliageMaterial
        );
        tier1.position.y = 1.6;
        tier1.castShadow = true;
        treeGroup.add(tier1);
        
        const tier2 = new THREE.Mesh(
          new THREE.ConeGeometry(1, 1.3, 12), 
          foliageMaterial
        );
        tier2.position.y = 2.5;
        tier2.castShadow = true;
        treeGroup.add(tier2);
        
        const tier3 = new THREE.Mesh(
          new THREE.ConeGeometry(0.7, 1.1, 12), 
          foliageMaterial
        );
        tier3.position.y = 3.3;
        tier3.castShadow = true;
        treeGroup.add(tier3);
        
        // Star on top
        const star = new THREE.Mesh(
          new THREE.IcosahedronGeometry(0.28, 0),
          new THREE.MeshBasicMaterial({ 
            color: 0xffd700,
            emissive: 0xffd700,
            emissiveIntensity: 1
          })
        );
        star.position.y = 4.2;
        treeGroup.add(star);
        
        // Ornaments
        const ornamentColors = [
          0xff0000, 0x0000ff, 0xffd700, 
          0xff1493, 0x00ff00, 0xff4500,
          0x9370db, 0xff69b4
        ];
        
        const ornaments = [];
        for (let i = 0; i < CONFIG.ORNAMENT_COUNT; i++) {
          const ornament = new THREE.Mesh(
            new THREE.SphereGeometry(0.1, 12, 12),
            new THREE.MeshStandardMaterial({
              color: ornamentColors[i % ornamentColors.length],
              metalness: 0.8,
              roughness: 0.2,
              emissive: ornamentColors[i % ornamentColors.length],
              emissiveIntensity: 0.3
            })
          );
          
          const tier = Math.floor(i / (CONFIG.ORNAMENT_COUNT / 3));
          const angle = (i * 137.5) * Math.PI / 180;
          const radius = 0.35 + Math.random() * 0.45 - tier * 0.12;
          const height = 1.3 + tier * 0.9 + Math.random() * 0.4;
          
          ornament.position.set(
            Math.cos(angle) * radius,
            height,
            Math.sin(angle) * radius
          );
          
          ornament.castShadow = true;
          treeGroup.add(ornament);
          ornaments.push(ornament);
        }
        
        // Internal glow
        const pointLight = new THREE.PointLight(0xffaa00, 2.5, 8);
        pointLight.position.set(0, 2.2, 0);
        treeGroup.add(pointLight);
        
        // Spotlight on star
        const starLight = new THREE.PointLight(0xffd700, 1.5, 4);
        starLight.position.copy(star.position);
        treeGroup.add(starLight);
        
        scene.add(treeGroup);
        
        // ============================================
        // GROUND
        // ============================================
        const ground = new THREE.Mesh(
          new THREE.CircleGeometry(15, 32),
          new THREE.MeshPhongMaterial({ 
            color: 0x1a3a4a,
            shininess: 5
          })
        );
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);
        
        // ============================================
        // SNOW PARTICLES
        // ============================================
        const snowGeo = new THREE.BufferGeometry();
        const snowPos = new Float32Array(CONFIG.SNOW_PARTICLES * 3);
        const snowVel = [];
        
        for (let i = 0; i < CONFIG.SNOW_PARTICLES; i++) {
          snowPos[i * 3] = (Math.random() - 0.5) * 15;
          snowPos[i * 3 + 1] = Math.random() * 12;
          snowPos[i * 3 + 2] = (Math.random() - 0.5) * 15;
          snowVel.push(0.015 + Math.random() * 0.025);
        }
        
        snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
        
        const snowMat = new THREE.PointsMaterial({
          color: 0xffffff,
          size: 0.1,
          transparent: true,
          opacity: 0.9,
          sizeAttenuation: true
        });
        
        const snowSystem = new THREE.Points(snowGeo, snowMat);
        scene.add(snowSystem);
        
        // Enable shadows
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        directionalLight.castShadow = true;
        
        // ============================================
        // ANIMATION LOOP
        // ============================================
        function animate() {
          animationFrameRef.current = requestAnimationFrame(animate);
          
          // FPS
          frameCount.current++;
          const now = performance.now();
          if (now - lastFrameTime.current > 1000) {
            setFPS(frameCount.current);
            frameCount.current = 0;
            lastFrameTime.current = now;
          }
          
          // Auto rotate when not dragging
          if (!isDragging.current && controlMode === 'auto') {
            targetRotation.current += CONFIG.AUTO_ROTATE_SPEED;
          }
          
          // Smooth rotation
          treeGroup.rotation.y += (targetRotation.current - treeGroup.rotation.y) * CONFIG.DAMPING;
          
          // Smooth scale
          const currentScale = treeGroup.scale.x;
          const newScale = currentScale + (targetScale.current - currentScale) * CONFIG.DAMPING;
          treeGroup.scale.set(newScale, newScale, newScale);
          
          // Rotate star
          star.rotation.y += 0.025;
          star.rotation.z = Math.sin(now * 0.001) * 0.15;
          
          // Pulsating star light
          starLight.intensity = 1.5 + Math.sin(now * 0.003) * 0.5;
          
          // Ornament sparkle
          ornaments.forEach((ornament, i) => {
            const sparkle = Math.sin(now * 0.002 + i * 0.5) * 0.5 + 0.5;
            ornament.material.emissiveIntensity = 0.2 + sparkle * 0.4;
          });
          
          // Snow falling
          const positions = snowGeo.attributes.position.array;
          for (let i = 0; i < CONFIG.SNOW_PARTICLES; i++) {
            positions[i * 3 + 1] -= snowVel[i];
            
            if (positions[i * 3 + 1] < 0) {
              positions[i * 3 + 1] = 12;
              positions[i * 3] = (Math.random() - 0.5) * 15;
              positions[i * 3 + 2] = (Math.random() - 0.5) * 15;
            }
          }
          snowGeo.attributes.position.needsUpdate = true;
          
          renderer.render(scene, camera);
        }
        
        animate();
        
        sceneRef.current = { 
          scene, 
          camera, 
          renderer, 
          treeGroup,
          star 
        };
        
        // Resize
        const handleResize = () => {
          const w = window.innerWidth;
          const h = window.innerHeight;
          camera.aspect = w / h;
          camera.updateProjectionMatrix();
          renderer.setSize(w, h);
        };
        
        window.addEventListener('resize', handleResize);
        
        return () => {
          window.removeEventListener('resize', handleResize);
          if (animationFrameRef.current) {
            cancelAnimationFrame(animationFrameRef.current);
          }
        };
      };
      
      // ============================================
      // MOUSE/TOUCH CONTROLS
      // ============================================
      const handlePointerDown = (e) => {
        isDragging.current = true;
        lastMouseX.current = e.clientX || e.touches?.[0]?.clientX || 0;
        setControlMode('mouse');
      };
      
      const handlePointerMove = (e) => {
        if (!isDragging.current) return;
        
        const currentX = e.clientX || e.touches?.[0]?.clientX || 0;
        const deltaX = currentX - lastMouseX.current;
        
        targetRotation.current += deltaX * 0.01;
        lastMouseX.current = currentX;
      };
      
      const handlePointerUp = () => {
        isDragging.current = false;
      };
      
      const handleWheel = (e) => {
        e.preventDefault();
        const delta = e.deltaY * -0.001;
        targetScale.current = Math.max(0.5, Math.min(2.5, targetScale.current + delta));
      };
      
      // Double click to spin
      const handleDoubleClick = () => {
        if (!isSpinning.current) {
          isSpinning.current = true;
          const spinDuration = 2000;
          const startRot = targetRotation.current;
          const startTime = performance.now();
          
          const spin = () => {
            const elapsed = performance.now() - startTime;
            if (elapsed < spinDuration) {
              const progress = elapsed / spinDuration;
              targetRotation.current = startRot + (Math.PI * 2) * progress;
              requestAnimationFrame(spin);
            } else {
              isSpinning.current = false;
            }
          };
          
          spin();
        }
      };
      
      // ============================================
      // INITIALIZATION
      // ============================================
      useEffect(() => {
        setAppState('LOADING');
        
        setTimeout(() => {
          initThreeJS();
          setAppState('READY');
          setTimeout(() => setShowInstructions(false), 8000);
        }, 1000);
        
        return () => {
          if (animationFrameRef.current) {
            cancelAnimationFrame(animationFrameRef.current);
          }
        };
      }, []);
      
      // ============================================
      // UI RENDERING
      // ============================================
      
      if (appState === 'INIT' || appState === 'LOADING') {
        return h('div', {
          className: 'w-screen h-screen bg-gradient-to-b from-blue-900 via-purple-900 to-green-900 flex items-center justify-center'
        },
          h('div', { className: 'text-center' },
            h('div', { className: 'text-8xl mb-6 float-animation' }, 'üéÑ'),
            h('h1', { className: 'text-white text-5xl font-bold mb-3' }, 'AR C√¢y Th√¥ng Noel'),
            h('p', { className: 'text-white/80 text-lg' }, 'ƒêang kh·ªüi ƒë·ªông...'),
            h('div', { className: 'mt-8' },
              h('div', { 
                className: 'w-16 h-16 border-4 border-white/30 border-t-white rounded-full mx-auto',
                style: { animation: 'spin 1s linear infinite' }
              })
            )
          )
        );
      }
      
      return h('div', { 
        className: 'relative w-screen h-screen overflow-hidden',
        onMouseDown: handlePointerDown,
        onMouseMove: handlePointerMove,
        onMouseUp: handlePointerUp,
        onMouseLeave: handlePointerUp,
        onTouchStart: handlePointerDown,
        onTouchMove: handlePointerMove,
        onTouchEnd: handlePointerUp,
        onWheel: handleWheel,
        onDoubleClick: handleDoubleClick
      },
        h('canvas', {
          ref: canvasRef,
          className: 'absolute inset-0 w-full h-full cursor-grab active:cursor-grabbing'
        }),
        
        // HUD
        h('div', { className: 'absolute inset-0 pointer-events-none select-none' },
          // Top bar
          h('div', { className: 'absolute top-4 left-4 right-4 flex justify-between items-start z-10' },
            h('div', { 
              className: 'bg-black/70 backdrop-blur text-white px-5 py-2 rounded-full text-sm font-medium shadow-2xl border border-white/20' 
            }, 
              controlMode === 'auto' ? 'üîÑ T·ª± ƒë·ªông xoay' : 'üñ±Ô∏è K√©o ƒë·ªÉ xoay'
            ),
            
            h('div', { className: 'flex gap-2' },
              h('div', { 
                className: 'bg-black/70 backdrop-blur text-white px-3 py-1 rounded-full text-xs border border-white/20' 
              }, `${fps} FPS`),
              
              h('button', {
                className: 'bg-green-500/90 backdrop-blur text-white px-4 py-1 rounded-full text-xs font-bold pointer-events-auto active:scale-95 transition shadow-xl border border-white/30',
                onClick: () => setControlMode(controlMode === 'auto' ? 'mouse' : 'auto')
              }, controlMode === 'auto' ? '‚è∏Ô∏è D·ª´ng' : '‚ñ∂Ô∏è T·ª± ƒë·ªông'),
              
              h('button', {
                className: 'bg-red-500/90 backdrop-blur text-white px-4 py-1 rounded-full text-xs font-bold pointer-events-auto active:scale-95 transition shadow-xl',
                onClick: () => window.location.reload()
              }, 'üîÑ')
            )
          ),
          
          // Instructions
          showInstructions && h('div', {
            className: 'absolute bottom-20 left-0 right-0 text-center transition-opacity duration-1000'
          },
            h('div', { 
              className: 'bg-gradient-to-t from-black/90 via-black/80 to-transparent pt-16 pb-10 px-6' 
            },
              h('h3', { 
                className: 'text-white text-2xl font-bold mb-6',
                style: { textShadow: '0 4px 20px rgba(0,0,0,0.9)' }
              }, 'üéÑ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng'),
              
              h('div', { className: 'space-y-3 max-w-md mx-auto' },
                h('div', { className: 'bg-white/10 backdrop-blur rounded-xl p-3 border border-white/20' },
                  h('p', { className: 'text-white font-semibold' }, 'üñ±Ô∏è K√©o chu·ªôt ƒë·ªÉ xoay c√¢y')
                ),
                h('div', { className: 'bg-white/10 backdrop-blur rounded-xl p-3 border border-white/20' },
                  h('p', { className: 'text-white font-semibold' }, 'üîç LƒÉn chu·ªôt ƒë·ªÉ zoom in/out')
                ),
                h('div', { className: 'bg-white/10 backdrop-blur rounded-xl p-3 border border-white/20' },
                  h('p', { className: 'text-white font-semibold' }, 'üëÜ Double-click ƒë·ªÉ xoay 360¬∞')
                )
              ),
              
              h('button', {
                className: 'mt-6 bg-white/20 hover:bg-white/30 text-white px-6 py-2 rounded-full text-sm font-bold pointer-events-auto transition backdrop-blur border border-white/30',
                onClick: () => setShowInstructions(false)
              }, '‚úì ƒê√£ hi·ªÉu')
            )
          ),
          
          // Branding
          h('div', { className: 'absolute bottom-6 left-0 right-0 text-center z-10' },
            h('a', {
              href: 'https://github.com/vukimvung',
              target: '_blank',
              className: 'text-white/90 text-base font-serif italic pointer-events-auto hover:text-white transition-colors drop-shadow-lg',
              style: { textShadow: '0 2px 20px rgba(0,0,0,0.9)' }
            }, '‚ú® Created by V≈© Kim V·ªØng')
          )
        )
      );
    }
    
    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(h(App));
  </script>
</body>
</html>
